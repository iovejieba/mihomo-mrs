name: Auto Convert Clash Rules to MRS

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl wget

      - name: Install Mihomo
        run: |
          MIHOMO_LATEST_URL=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" | jq -r '.assets[] | select(.name | contains("linux-amd64-compatible")) | .browser_download_url')
          if [ -z "$MIHOMO_LATEST_URL" ]; then
            MIHOMO_LATEST_URL=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" | jq -r '[.assets[] | select(.name | contains("linux-amd64") and endswith(".gz"))] | .[0].browser_download_url')
          fi
          wget -qO mihomo.gz "$MIHOMO_LATEST_URL"
          gunzip mihomo.gz && chmod +x mihomo && sudo mv mihomo /usr/local/bin/

      - name: Process and Convert Rules
        run: |
          set -e
          DOWNLOADS_DIR="downloads_tmp"
          mkdir -p "$DOWNLOADS_DIR"

          DATE_SUFFIX=$(date -u +"%Y-%m-%d")
          RUN_COUNT=$(git tag -l "${DATE_SUFFIX}-*" | wc -l)
          VERSION_TAG="${DATE_SUFFIX}-${RUN_COUNT}"
          VERSIONED_OUTPUT_DIR="versioned_rules/$VERSION_TAG"
          RULES_OUTPUT_DIR="$VERSIONED_OUTPUT_DIR/rules"
          mkdir -p "$RULES_OUTPUT_DIR"
          
          PROVIDER_LINES_TMP="provider_lines.tmp"
          RULESET_LINES_TMP="ruleset_lines.tmp"
          PROXY_GROUPS_TMP="proxy_groups.tmp"
          > "$PROVIDER_LINES_TMP"
          > "$RULESET_LINES_TMP"
          > "$PROXY_GROUPS_TMP"

          # --- Ê†∏ÂøÉÂáΩÊï∞ÔºöMRS Áâ©ÁêÜËΩ¨Êç¢ ---
          convert_and_commit_rule() {
              local type="$1"; local format="$2"; local input_file="$3"; local base_name="$4"; local output_dir="$5"; local group_name="$6"
              local provider_name="$base_name"; local url_path="main/latest/${base_name}"
              
              if [[ "$type" == "classical" ]]; then
                  cp "$input_file" "$output_dir/${base_name}.list"
                  echo "  ${provider_name}: { <<: *classical, url: 'https://raw.githubusercontent.com/${{ github.repository }}/${url_path}.list' }" >> "$PROVIDER_LINES_TMP"
              else
                  local output_file="$output_dir/${base_name}.mrs"
                  if [[ "$format" == "text" ]]; then
                      awk -F, '!/^#/ && !/^[ \t\r\n]*$/ { if (NF > 1) { print $2; } else { print $0; } }' "$input_file" > "clean.tmp"
                      mihomo convert-ruleset "$type" "$format" "clean.tmp" "$output_file" && rm -f "clean.tmp"
                  else
                      mihomo convert-ruleset "$type" "$format" "$input_file" "$output_file"
                  fi
                  local anchor_name="mrs"; [ "$type" == "ipcidr" ] && anchor_name="mrsip"
                  echo "  ${provider_name}: { <<: *${anchor_name}, url: 'https://raw.githubusercontent.com/${{ github.repository }}/${url_path}.mrs' }" >> "$PROVIDER_LINES_TMP"
                  echo "  - RULE-SET,${provider_name},${group_name}" >> "$RULESET_LINES_TMP"
              fi
          }

          # --- Ê†∏ÂøÉÂáΩÊï∞ÔºöÂüüÂêç/IP Áâ©ÁêÜÂàÜÊãÜ ---
          split_and_convert() {
              local input_file="$1"; local base_name="$2"; local output_dir="$3"; local group_name="$4"; local f_type="$5"
              local d_f="${base_name}_domain.txt"; local i_f="${base_name}_ipcidr.txt"; local o_f="${base_name}_other.list"
              > "$d_f"; > "$i_f"; > "$o_f"
              local awk_s='function strip(s) { sub(/^[ \t\r\n]+/, "", s); sub(/[ \t\r\n]+$/, "", s); return s; } { line = strip($0); if (index(line, ",")) { prefix = toupper(substr(line, 1, index(line, ",") - 1)); if (prefix == "DOMAIN" || prefix == "DOMAIN-SUFFIX" || prefix == "DOMAIN-KEYWORD") { print line >> "'"$d_f"'" } else if (prefix == "IP-CIDR" || prefix == "IP-CIDR6") { print line >> "'"$i_f"'" } else { print line >> "'"$o_f"'" } } else { print line >> "'"$d_f"'" } }'
              [[ "$f_type" == "yaml" ]] && (sed -n '/payload:/,$p' "$input_file" | sed -e '1d' -e 's/^[ \t-]*//;s/["'\'']//g' | awk "$awk_s") || (awk '!/^#/ && !/^[ \t\r\n]*$/' "$input_file" | awk "$awk_s")
              [ -s "$d_f" ] && convert_and_commit_rule "domain" "text" "$d_f" "${base_name}_domain" "$output_dir" "$group_name"
              [ -s "$i_f" ] && convert_and_commit_rule "ipcidr" "text" "$i_f" "${base_name}_ipcidr" "$output_dir" "$group_name"
              [ -s "$o_f" ] && convert_and_commit_rule "classical" "text" "$o_f" "${base_name}_other" "$output_dir" "$group_name"
              rm -f "$d_f" "$i_f" "$o_f"
          }

          # --- ‰∏ªÈÄªËæëÔºöËß£Êûê INI ---
          INI_URL="https://raw.githubusercontent.com/webshell8808/clash/refs/heads/main/Custom_Clash.ini"
          INI_FILE="$DOWNLOADS_DIR/GeneralClashRule.ini"
          curl -L -s -o "$INI_FILE" "$INI_URL"

          grep "custom_proxy_group=" "$INI_FILE" | while read -r gline; do
              g_content=$(echo "$gline" | sed 's/custom_proxy_group=//' | tr -d '\r')
              g_name=$(echo "$g_content" | cut -d'`' -f1); g_type=$(echo "$g_content" | cut -d'`' -f2)
              echo "  - {name: \"$g_name\", type: $g_type, <<: *pr}" >> "$PROXY_GROUPS_TMP"
          done

          while IFS= read -r line; do
              line_content=$(echo "$line" | sed -e 's/^\s*ruleset=//' -e 's/clash-classic://' | tr -d '\r')
              url=$(echo "$line_content" | sed 's/.*,//'); name=$(echo "$line_content" | sed 's/,.*//')
              if [[ "$url" == "[]FINAL" ]]; then 
                  echo "  - MATCH,$name" >> "$RULESET_LINES_TMP"
              else 
                ext="${url##*.}"; d_file="$DOWNLOADS_DIR/$(date +%s%N).${ext}"
                curl -L -s -o "$d_file" "$url" && { [[ "$ext" == "yaml" ]] && split_and_convert "$d_file" "$name" "$RULES_OUTPUT_DIR" "$name" "yaml" || split_and_convert "$d_file" "$name" "$RULES_OUTPUT_DIR" "$name" "text"; }
              fi
          done < <(grep -E '^\s*ruleset=' "$INI_FILE")

          # --- ÈÖçÁΩÆÊñá‰ª∂ÁîüÊàêÂáΩÊï∞ ---
          generate_config() {
              local mode="$1"; local output="$2"
              {
                echo "---"
                echo "# Á≠ñÁï•ÁªÑÁõ∏ÂÖ≥ÈîöÁÇπ"
                echo "pr: &pr {proxies: [ËäÇÁÇπÈÄâÊã©, Ëá™Âä®ÈÄâÊã©, üá≠üá∞ È¶ôÊ∏ØËäÇÁÇπ, üáØüáµ Êó•Êú¨ËäÇÁÇπ, üá∞üá∑ Èü©ÂõΩËäÇÁÇπ, üá∏üá¨ Êñ∞Âä†Âù°ËäÇÁÇπ, üá∫üá∏ ÁæéÂõΩËäÇÁÇπ, üáπüáº Âè∞ÊπæËäÇÁÇπ, üá¨üáß Ëã±ÂõΩËäÇÁÇπ, üá´üá∑ Ê≥ïÂõΩËäÇÁÇπ, üá©üá™ Âæ∑ÂõΩËäÇÁÇπ, üá≥üá± Ëç∑ÂÖ∞ËäÇÁÇπ, üá®üá¶ Âä†ÊãøÂ§ßËäÇÁÇπ, üáπüá∑ ÂúüËÄ≥ÂÖ∂ËäÇÁÇπ, üáªüá≥ Ë∂äÂçóËäÇÁÇπ, ÂÖ∂‰ªñ, DIRECT]}"
                echo "url-test: &url-test {type: url-test, url: http://cp.cloudflare.com/generate_204, interval: 300, include-all-providers: true, exclude-filter: \"LAN\"}"
                echo "p: &p {type: http, interval: 86400, health-check: {enable: true, url: http://cp.cloudflare.com/generate_204, interval: 300}}"
                echo ""
                echo "proxy-providers:"
                echo "  Sub-Store: { <<: *p, url: \"ËØ∑Âú®Ê≠§Â§ÑÂ°´ÂÖ•ËÆ¢ÈòÖÂú∞ÂùÄ\" }"
                echo ""
                echo "mixed-port: 7890"
                echo "allow-lan: true"
                echo "unified-delay: true"
                echo "tcp-concurrent: true"
                echo ""
                echo "profile:"
                echo "  store-selected: true"
                [ "$mode" == "fake-ip" ] && echo "  store-fake-ip: true" || echo "  store-fake-ip: false"
                echo ""
                if [ "$mode" == "fake-ip" ]; then
                  echo "dns:"
                  echo "  enable: true"
                  echo "  enhanced-mode: fake-ip"
                  echo "  fake-ip-range: 198.18.0.1/16"
                  echo "  respect-rules: true"
                  echo "  nameserver: ['https://8.8.8.8/dns-query', '223.5.5.5']"
                elif [ "$mode" == "redir-host" ]; then
                  echo "dns:"
                  echo "  enable: true"
                  echo "  enhanced-mode: redir-host"
                  echo "  respect-rules: true"
                  echo "  nameserver: ['https://8.8.8.8/dns-query', '223.5.5.5']"
                else
                  echo "dns: { enable: false }"
                fi
                echo ""
                echo "proxy-groups:"
                echo "  - {name: ËäÇÁÇπÈÄâÊã©, type: select, use: [Sub-Store], proxies: [Ëá™Âä®ÈÄâÊã©, üá≠üá∞ È¶ôÊ∏ØËäÇÁÇπ, üáØüáµ Êó•Êú¨ËäÇÁÇπ, üá∞üá∑ Èü©ÂõΩËäÇÁÇπ, üá∏üá¨ Êñ∞Âä†Âù°ËäÇÁÇπ, üá∫üá∏ ÁæéÂõΩËäÇÁÇπ, üáπüáº Âè∞ÊπæËäÇÁÇπ, üá¨üáß Ëã±ÂõΩËäÇÁÇπ, üá´üá∑ Ê≥ïÂõΩËäÇÁÇπ, üá©üá™ Âæ∑ÂõΩËäÇÁÇπ, üá≥üá± Ëç∑ÂÖ∞ËäÇÁÇπ, üá®üá¶ Âä†ÊãøÂ§ßËäÇÁÇπ, üáπüá∑ ÂúüËÄ≥ÂÖ∂ËäÇÁÇπ, üáªüá≥ Ë∂äÂçóËäÇÁÇπ, ÂÖ∂‰ªñ, DIRECT]}"
                echo "  - {name: Ëá™Âä®ÈÄâÊã©, type: url-test, use: [Sub-Store], <<: *url-test}"
                echo "  - {name: üá≠üá∞ È¶ôÊ∏ØËäÇÁÇπ, type: url-test, use: [Sub-Store], filter: \"(?i)Ê∏Ø|HK|Hong Kong|HongKong\", <<: *url-test}"
                echo "  - {name: üáØüáµ Êó•Êú¨ËäÇÁÇπ, type: url-test, use: [Sub-Store], filter: \"(?i)Êó•Êú¨|‰∏ú‰∫¨|Â§ßÈò™|JP|Japan\", <<: *url-test}"
                echo "  - {name: üá∞üá∑ Èü©ÂõΩËäÇÁÇπ, type: url-test, use: [Sub-Store], filter: \"(?i)KR|Korea|KOR|È¶ñÂ∞î|Èü©|Èüì\", <<: *url-test}"
                echo "  - {name: üá∏üá¨ Êñ∞Âä†Âù°ËäÇÁÇπ, type: url-test, use: [Sub-Store], filter: \"(?i)Êñ∞Âä†Âù°|Âù°|ÁãÆÂüé|SG|Singapore\", <<: *url-test}"
                echo "  - {name: üá∫üá∏ ÁæéÂõΩËäÇÁÇπ, type: url-test, use: [Sub-Store], filter: \"(?i)Áæé|Ê≥¢ÁâπÂÖ∞|ËææÊãâÊñØ|US|United States\", <<: *url-test}"
                echo "  - {name: üáπüáº Âè∞ÊπæËäÇÁÇπ, type: url-test, use: [Sub-Store], filter: \"(?i)Âè∞|Êñ∞Âåó|ÂΩ∞Âåñ|TW|Taiwan\", <<: *url-test}"
                echo "  - {name: üá¨üáß Ëã±ÂõΩËäÇÁÇπ, type: url-test, use: [Sub-Store], filter: \"(?i)Ëã±ÂõΩ|UK|Great Britain\", <<: *url-test}"
                echo "  - {name: üá´üá∑ Ê≥ïÂõΩËäÇÁÇπ, type: url-test, use: [Sub-Store], filter: \"(?i)Ê≥ïÂõΩ|FR|France\", <<: *url-test}"
                echo "  - {name: üá©üá™ Âæ∑ÂõΩËäÇÁÇπ, type: url-test, use: [Sub-Store], filter: \"(?i)Âæ∑ÂõΩ|DE|Germany\", <<: *url-test}"
                echo "  - {name: üá≥üá± Ëç∑ÂÖ∞ËäÇÁÇπ, type: url-test, use: [Sub-Store], filter: \"(?i)Ëç∑ÂÖ∞|NL|Netherlands\", <<: *url-test}"
                echo "  - {name: üá®üá¶ Âä†ÊãøÂ§ßËäÇÁÇπ, type: url-test, use: [Sub-Store], filter: \"(?i)Âä†ÊãøÂ§ß|CA|Canada\", <<: *url-test}"
                echo "  - {name: üáπüá∑ ÂúüËÄ≥ÂÖ∂ËäÇÁÇπ, type: url-test, use: [Sub-Store], filter: \"(?i)ÂúüËÄ≥ÂÖ∂|TR|Turkey|T√ºrkiye\", <<: *url-test}"
                echo "  - {name: üáªüá≥ Ë∂äÂçóËäÇÁÇπ, type: url-test, use: [Sub-Store], filter: \"(?i)Ë∂äÂçó|VN|Vietnam\", <<: *url-test}"
                echo "  - {name: ÂÖ∂‰ªñ, type: select, use: [Sub-Store], exclude-filter: \"(?i)HK|JP|KR|SG|US|TW|UK|FR|DE|NL|CA|TR|VN|LAN\"}"
                cat "$PROXY_GROUPS_TMP" | sed 's/proxies: \[\]/use: \[Sub-Store\]/g'
                echo ""
                echo "rule-anchor:"
                echo "  mrs: &mrs { type: http, interval: 86400, behavior: domain, format: mrs }"
                echo "  mrsip: &mrsip { type: http, interval: 86400, behavior: ipcidr, format: mrs }"
                echo "  classical: &classical { type: http, interval: 86400, behavior: classical, format: text }"
                echo ""
                echo "rule-providers:"
                cat "$PROVIDER_LINES_TMP"
                echo ""
                echo "rules:"
                echo "  - DST-PORT,3478/19302,DIRECT"
                echo "  - GEOIP,lan,DIRECT,no-resolve"
                cat "$RULESET_LINES_TMP"
              } > "$output"
          }

          generate_config "fake-ip" "$VERSIONED_OUTPUT_DIR/provider_config_fakeip.yaml"
          generate_config "redir-host" "$VERSIONED_OUTPUT_DIR/provider_config_redirhost.yaml"
          generate_config "standard" "$VERSIONED_OUTPUT_DIR/provider_config.yaml"

          # Ê†πÁõÆÂΩï‰∏é latest ÂêåÊ≠•‰∫ßÂá∫
          rm -rf latest && mkdir -p latest
          cp -rf "$RULES_OUTPUT_DIR"/* latest/
          cp -f "$VERSIONED_OUTPUT_DIR"/provider_config*.yaml ./
          cp -f "$VERSIONED_OUTPUT_DIR"/provider_config*.yaml latest/
          echo "VERSION_TAG=${VERSION_TAG}" >> $GITHUB_ENV
          git tag "$VERSION_TAG"

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git push origin "refs/tags/${{ env.VERSION_TAG }}"
          if ! git diff --staged --quiet; then git commit -m "feat: rules and configs for all modes ${{ env.VERSION_TAG }}"; git push; fi
